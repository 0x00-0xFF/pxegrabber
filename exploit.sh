#!/bin/sh

/etc/init.d/dhcp.sh

MACADDRESS="`cat /sys/class/net/eth0/address|sed 's/\:/-/g'`"
DEFGW="`netstat -rn | grep 0.0.0.0 | awk '{print $2}' | grep -v "0.0.0.0"`"
FILE="grabs.txt"
FILEwPATH="/tmp/grabs.txt"
PARTITIONS="/tmp/partitions.txt"
LOGPATH="/tmp/fakelog.txt"
ERROR=0

echo $DEFGW
echo $MACADDRESS

# Mount all available partitions of guest system
mountpartitions (){
	# Make temp directory
	mkdir /tmp/$MACADDRESS

	# Get all partitions to be mounted
	TARGET_PARTITIONS=$(awk '{print $4}' /proc/partitions | sed -e '/name/d' -e '/^$/d' -e '/[1-9]/!d')
	# Save partitions to file
	echo $TARGET_PARTITIONS > $PARTITIONS
	# Count the number of partitions to be mounted
	PARTITION_COUNT=$(wc -l < $PARTITIONS)
	# Save disk information to file
	fdisk -l >> /tmp/$MACADDRESS/asdf.txt

	echo ""
	for i in $TARGET_PARTITIONS
		do mkdir -p /mnt/$i
		# Save partition information to file
		fdisk -l /dev/$i >> /tmp/$MACADDRESS/asdf.txt
		sudo mount -o ro -t auto /dev/$i
		if [ $? -eq 0 ];
		then
			echo "Succesfully mounted $i!"
			PARTITION_COUNT=$((PARTITION_COUNT-1))
		else
			echo "Failed to mount $i"

		fi
	done

	# Check if were able to mount all devices
	if [ $PARTITION_COUNT -ne 0 ];
	then
		echo "Failed to mount all devices"
	fi
}

# Retrieve $FILE with filenames to search for.
getGrabs (){

	echo ""
	cd /tmp
	tftp $DEFGW -m binary -c get $FILE >$LOGPATH 2>&1
	if [ $(cat $LOGPATH | wc -l) -eq 0 ]; 
	then
		echo "Successfully retrieved $FILE"
	else
		ERROR=1
		echo "Failed to retrieve $FILE"
	fi
}

# Find the specified files in $FILE.
findFiles (){

	echo ""

	#Search & copy files to tmp directory
	while read -r line
	do
		echo "File to search for: - $line" >> /tmp/$MACADDRESS/asdf.txt
		for i in $TARGET_PARTITIONS
		do
			find /mnt/$i -iname $line -exec cp --parents {} /tmp/$MACADDRESS \;
		done
	done < $FILEwPATH
}

# Compress found files in tar archive, generate md5 of resulting file
tarfiles (){

	echo ""
	tar -zcvf /tmp/$MACADDRESS.tar.gz /tmp/$MACADDRESS/
	echo ""
	if [ $? -eq 0 ]; 
	then
		echo "Successfully packaged files"
		md5sum /tmp/$MACADDRESS.tar.gz > /tmp/$MACADDRESS.md5
		HASH=$(md5sum /tmp/$MACADDRESS.tar.gz | awk '{print $1}')
		echo ""
		echo "MD5 hash of $MACADDRESS.tar.gz is: $HASH"
	else
		ERROR=1
		echo "Failed to package files"
	fi
}

# Send resulting archive & md5 file to tftp server
sendFiles (){

	echo ""
	cd /tmp/
	tftp $DEFGW -m binary -c put /tmp/$MACADDRESS.tar.gz >$LOGPATH 2>&1
	if [ $(cat $LOGPATH | wc -l) -eq 0 ]; 
	then
		echo "Successfully sent file $MACADDRESS.tar.gz"
		echo ""
		tftp $DEFGW -m binary -c put /tmp/$MACADDRESS.md5 >$LOGPATH 2>&1
		if [ $(cat $LOGPATH | wc -l) -eq 0 ]; 
		then
			echo "Successfully sent file $MACADDRESS.md5"
		else
			echo "Failed to send file $MACADDRESS.md5"
		fi
	else
		ERROR=1
		echo "Failed to send file $MACADDRESS.tar.gz"
	fi
}

# Shit went wrong, no need to continue...
handleError (){

	echo "Something went wrong, exiting..."
}

mountpartitions
getGrabs

if [ $ERROR -eq 0 ] && [ $? -eq 0 ];
then
	findFiles
else
	handleError
fi

if [ $ERROR -eq 0 ] && [ $? -eq 0 ];
then
	tarfiles
else
	handleError
fi

if [ $ERROR -eq 0 ] && [ $? -eq 0 ];
then
	sendFiles
else
	handleError
fi
poweroff
